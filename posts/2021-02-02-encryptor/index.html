<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Encrypt0r | fernetInjection</title><meta name=description content="We are fernetInjection, a CTF team from Argentina ðŸ‡¦ðŸ‡·. Here you can find our write-ups and reflections."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Encrypt0r"><meta property="og:description" content="Recon This challenge had no hint and no downloadable part, it was just an ip address and a port. So let&rsquo;s fire up a netcat instance and see what we&rsquo;ve got:
$ nc 161.97.176.150 4449 Heres the flag! 848630917051893087050233654298398605870572417880786546004017 Enter a value for me to encrypt > Ok, we&rsquo;ve got the flag and it looks like it&rsquo;s encrypted, so we&rsquo;re gonna have to get a sense for what&rsquo;s going on behind the scenes just by looking at plaintext/ciphertext pairs."><meta property="og:type" content="article"><meta property="og:url" content="https://fernetinjection.github.io/posts/2021-02-02-encryptor/"><meta property="article:published_time" content="2021-02-02T09:00:00+00:00"><meta property="article:modified_time" content="2021-02-02T09:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Encrypt0r"><meta name=twitter:description content="Recon This challenge had no hint and no downloadable part, it was just an ip address and a port. So let&rsquo;s fire up a netcat instance and see what we&rsquo;ve got:
$ nc 161.97.176.150 4449 Heres the flag! 848630917051893087050233654298398605870572417880786546004017 Enter a value for me to encrypt > Ok, we&rsquo;ve got the flag and it looks like it&rsquo;s encrypted, so we&rsquo;re gonna have to get a sense for what&rsquo;s going on behind the scenes just by looking at plaintext/ciphertext pairs."><link rel=stylesheet href=https://fernetinjection.github.io/css/style-dark.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://fernetinjection.github.io/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a><a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a><a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast');" style=display:none><i class="fas fa-chevron-up fa-lg"></i></a><span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://fernetinjection.github.io/posts/2021-02-01-cli-browser/><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li><li><a class=icon href=#><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f"><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&text=Encrypt0r"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&is_video=false&description=Encrypt0r"><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Encrypt0r&body=Check out this article: https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f"><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-stumbleupon" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-digg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&name=Encrypt0r&description=Recon%20This%20challenge%20had%20no%20hint%20and%20no%20downloadable%20part%2c%20it%20was%20just%20an%20ip%20address%20and%20a%20port.%20So%20let%26rsquo%3bs%20fire%20up%20a%20netcat%20instance%20and%20see%20what%20we%26rsquo%3bve%20got%3a%0a%24%20nc%20161.97.176.150%204449%20Heres%20the%20flag%21%20848630917051893087050233654298398605870572417880786546004017%20Enter%20a%20value%20for%20me%20to%20encrypt%20%26gt%3b%20Ok%2c%20we%26rsquo%3bve%20got%20the%20flag%20and%20it%20looks%20like%20it%26rsquo%3bs%20encrypted%2c%20so%20we%26rsquo%3bre%20gonna%20have%20to%20get%20a%20sense%20for%20what%26rsquo%3bs%20going%20on%20behind%20the%20scenes%20just%20by%20looking%20at%20plaintext%2fciphertext%20pairs."><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&t=Encrypt0r"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#recon>Recon</a><ul><li><a href=#figuring-out-the-encryption-algorithm>Figuring out the encryption algorithm</a></li></ul></li><li><a href=#decrypting-the-ciphertext>Decrypting the ciphertext</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Encrypt0r</h1><div class=meta><div class=postdate><time datetime="2021-02-02 09:00:00 +0000 UTC" itemprop=datePublished>2021-02-02</time></div><div class=article-category><i class="fas fa-archive"></i><a class=category-link href=/categories/ctf>CTF</a></div><div class=article-tag><i class="fas fa-tag"></i><a class=tag-link href=/tags/cryptography rel=tag>Cryptography</a>
<a class=tag-link href=/tags/ctf_0x41414141 rel=tag>CTF_0x41414141</a>
<a class=tag-link href=/tags/exploitation rel=tag>Exploitation</a></div></div></header><div class=content itemprop=articleBody><h2 id=recon>Recon</h2><p>This challenge had no hint and no downloadable part, it was just an ip address and a port. So let&rsquo;s fire up a netcat instance and see what we&rsquo;ve got:</p><pre><code>$ nc 161.97.176.150 4449
Heres the flag!
848630917051893087050233654298398605870572417880786546004017
Enter a value for me to encrypt
&gt; 
</code></pre><p>Ok, we&rsquo;ve got the flag and it looks like it&rsquo;s encrypted, so we&rsquo;re gonna have to get a sense for what&rsquo;s going on behind the scenes just by looking at plaintext/ciphertext pairs. Let&rsquo;s go ahead and input some test values!</p><pre><code>...
&gt; 0
0
Enter a value for me to encrypt
&gt; 1
1
Enter a value for me to encrypt
&gt; 2
405518048190558088634310202493589629933137815074909354184258
Enter a value for me to encrypt
&gt; 3
736006545906739541375355456172047521086543171458483024077845
Enter a value for me to encrypt
&gt; 4
28287358476740482187432197716177875720480221862681611755228
Enter a value for me to encrypt
&gt; 5
118164290266571816954914720950212104095415618051341152315626
Enter a value for me to encrypt
&gt; 6
624812891132136026422679120907420745781542687268597375922197
Enter a value for me to encrypt
&gt; 7
116537355815898013151362092320072496065628205811108848493645
Enter a value for me to encrypt
&gt;
</code></pre><h3 id=figuring-out-the-encryption-algorithm>Figuring out the encryption algorithm</h3><p>At first, it doesn&rsquo;t look like it&rsquo;s giving us much information, but after looking at it for some time we might notice something. Have you seen how <code>e(0)=0</code> and <code>e(1)=1</code>?</p><blockquote><p>By <code>e(x)</code> I&rsquo;m denoting the encrypted value of <code>x</code></p></blockquote><p>Another interesting fact is that the output gets larger as the input grows and eventually it just shrinks a bit, then it starts growing again. All of this gives us the idea that there might be some modular arithmetic going on here. At this point, I&rsquo;m guessing the encryption function looks something like this <code>e(x) = f(x) mod n</code> where <code>f</code> is an unkown function.</p><blockquote><p>Before I go any further, let me state that all we&rsquo;re doing here is just pure speculation. We don&rsquo;t have the code that&rsquo;s running in the backend, so we&rsquo;re only guessing. With that out of the way, let&rsquo;s keep on going.</p></blockquote><p>It&rsquo;s clear that <code>f</code> can&rsquo;t be a linear function, since <code>f(0)=0</code> and <code>f(1)=1</code> (supossing our previous guess about how <code>e</code> looks is correct), and this would mean that <code>f</code> would <em>have to be</em> the identity function. Also, <code>f</code> looks pretty chaotic, it suddenly jumped from <code>1</code> to <code>405518048190558088634310202493589629933137815074909354184258</code> (at least, its remainder modulo <code>n</code> did). After trying with different families of functions I came to the conclusion that <code>f(x)</code> looks like <code>x ^ r</code> (I&rsquo;m using the symbol <code>^</code> to denote exponentiation, due to the lack of mathematical notation capabilities in Markdown) where <code>r</code> is some unknown value. Why should this be the case? Well, the values for <code>f(0)</code> and <code>f(1)</code> give us the idea that <code>f</code> should be some kind of polynomial, but there can&rsquo;t be a lot of additions and/or subtractions involved. Keep in mind, up to this point this is nothing but a wild guess.</p><p>Let&rsquo;s review what we&rsquo;ve got up to this point, we have the hypothesis that <code>e(x) = x^r mod n</code> for some unkown value of <code>r</code> and <code>n</code>. Ok, let&rsquo;s try something, let&rsquo;s input <code>-1</code>, if our hypothesis is correct, we should get back either <code>1</code> or <code>n-1</code> (depending on whether <code>r</code> is even or not):</p><pre><code>Enter a value for me to encrypt
&gt; -1
943005855809379805541572246085636463198876208104363395594608
</code></pre><p>Cool, this number is larger than the ones we&rsquo;ve seen up to this point, this should give us the idea that we&rsquo;re on the right track (since <code>n</code> is the modulus, <code>n-1</code> should be the greatest value we can get). Remember, if <code>f(x)=-1</code>, then <code>e(x)=n-1</code>, so adding <code>1</code> we should get the value for <code>n</code>. Now our encryption function is missing just one value: <code>r</code>. So let&rsquo;s try and calculate it! We&rsquo;re not doing anything too clever, let&rsquo;s just take some known plain/cipher-text pair and test every possible value for <code>r</code> until we get the answer. The code for this looks like this:</p><pre><code>pt = 2
ct = 405518048190558088634310202493589629933137815074909354184258
n = 943005855809379805541572246085636463198876208104363395594609

def encrypt(x, r):
	return (x ** r) % n

i = 0
while encrypt(pt, i) != ct:
	i += 1
print(i)
</code></pre><p>It took a few seconds, but it gave us the value <code>65537</code>. So, with this value figured out, we should be able to reproduce the encryption algorithm used in the backend. Let&rsquo;s test our hypthesis for a value we haven&rsquo;t seen up to this point. Keep in mind our encryption function now looks like this:</p><pre><code>r = 65537
n = 943005855809379805541572246085636463198876208104363395594609
def encrypt(x):
	return (x ** r) % n
</code></pre><p>After trying this out with some values we&rsquo;re able to see that our predicted ciphertext does indeed match the actual ciphertext sent by the backend. We were successfully able to figure out the encryption algorithm!</p><h2 id=decrypting-the-ciphertext>Decrypting the ciphertext</h2><p>We&rsquo;ve got the encryption mechanism, and the encrypted value. Our equation now looks like this: <code>f^r mod n = c</code> where <code>f</code> denotes the flag&rsquo;s value, <code>c</code> is the first ciphertext we got at the very beginning, and the other two are the constants we&rsquo;ve just calculated in the previous section. On top of that, after a quick google search, we find that <code>r</code> is prime. This is the point where I thought: &ldquo;Cool, I have one equation and one unkown, it&rsquo;s just a matter of solving for the unkown! I can even use <a href=https://en.wikipedia.org/wiki/Fermat%27s_little_theorem>Fermat&rsquo;s little theorem</a>, knowing that <code>r</code> is prime!&rdquo;.</p><p>After banging my head against the wall for a while, on of my teammates brought to my attention that this algorithm has a name: it&rsquo;s called <a href=https://en.wikipedia.org/wiki/RSA_(cryptosystem)>RSA</a>, and it&rsquo;s pretty robust (no wonder I wasn&rsquo;t being able to solve it!). Anyway, playing with the equation for a while might be useful, if only because one gets to develop some intuition for the problem and what makes it interesting.</p><blockquote><p>Quick sidenote on RSA: The idea behind RSA is that <code>n</code> should be the product of two (large) primes: <code>p</code> and <code>q</code>, those primes should be large enough to make it computationally unfeasible to factor <code>n</code>. The recipeint, on the other hand, should have those two primes, as they will be used for decryption. The number <code>r</code> (the exponent to which the plaintext is raised) should be co-prime to <code>lcm(p-1, q-1)</code>, so that there exists a number <code>d</code> which is the multiplicative inverse of <code>r</code> modulo <code>lcm(p-1, q-1)</code>. Then, when the intended recipient gets the encrypted message, all they have to do is raise <code>c</code> (the ciphertext) to the power of <code>d</code> and take it&rsquo;s remainder mod <code>n</code>. That should give back the original plaintext. That was a lot of information, I know, so: <strong>TLDR; We need to find the prime factors of <code>n</code></strong></p></blockquote><p>So the security of this algorithm depends on the difficulty of factoring <code>n</code>, but in this case <code>n</code> is not <em>that</em> big. It&rsquo;s big enough so that a naive factorization will take too long, but it&rsquo;s no bigger than that. So I googled a bit and found an <a href=https://www.alpertron.com.ar/ECM.HTM>online calculator</a> that would let me get the primes <code>p</code> and <code>q</code> relatively quickly. After a few seconds' wait, we&rsquo;ve got all the parameters we need to decrypt the ciphertext:</p><pre><code>import math
from Crypto.Util.number import long_to_bytes

cflag = 848630917051893087050233654298398605870572417880786546004017

p = 882152190529044698706991746907
q = 1068983182191997868299760689187
n = 943005855809379805541572246085636463198876208104363395594609 
r = 65537

assert n == p*q

lcm = math.lcm(p-1, q-1)
d = pow(r, -1, lcm)

def encrypt(x):
	return (x ** r) % n

def decrypt(x):
	return (x ** d) % n

flag = decrypt(cflag)

print(long_to_bytes(flag))
</code></pre><p>After waiting for a somewhat long time it becomes clear that is code is not very efficient, but if we use Python&rsquo;s <code>pow</code> function instead it becomes quite manageable:</p><pre><code>import math
from Crypto.Util.number import long_to_bytes

cflag = 848630917051893087050233654298398605870572417880786546004017

p = 882152190529044698706991746907
q = 1068983182191997868299760689187
n = 943005855809379805541572246085636463198876208104363395594609 
r = 65537

assert n == p*q

lcm = math.lcm(p-1, q-1)
d = pow(r, -1, lcm)

def encrypt(x):
	return pow(x, r, n)

def decrypt(x):
	return pow(x, d, n)

flag = decrypt(cflag)

print(long_to_bytes(flag))
</code></pre><p>And we get the flag:</p><p><code>y0u_d0nt_n33d_4nyth1ng</code></p><hr><h1 id=post-written-by-octaviogallandhttpsgithubcomoctaviogalland>Post written by <a href=https://github.com/OctavioGalland>@OctavioGalland</a></h1></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#recon>Recon</a><ul><li><a href=#figuring-out-the-encryption-algorithm>Figuring out the encryption algorithm</a></li></ul></li><li><a href=#decrypting-the-ciphertext>Decrypting the ciphertext</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f"><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&text=Encrypt0r"><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&is_video=false&description=Encrypt0r"><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Encrypt0r&body=Check out this article: https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f"><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-stumbleupon fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&title=Encrypt0r"><i class="fab fa-digg fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&name=Encrypt0r&description=Recon%20This%20challenge%20had%20no%20hint%20and%20no%20downloadable%20part%2c%20it%20was%20just%20an%20ip%20address%20and%20a%20port.%20So%20let%26rsquo%3bs%20fire%20up%20a%20netcat%20instance%20and%20see%20what%20we%26rsquo%3bve%20got%3a%0a%24%20nc%20161.97.176.150%204449%20Heres%20the%20flag%21%20848630917051893087050233654298398605870572417880786546004017%20Enter%20a%20value%20for%20me%20to%20encrypt%20%26gt%3b%20Ok%2c%20we%26rsquo%3bve%20got%20the%20flag%20and%20it%20looks%20like%20it%26rsquo%3bs%20encrypted%2c%20so%20we%26rsquo%3bre%20gonna%20have%20to%20get%20a%20sense%20for%20what%26rsquo%3bs%20going%20on%20behind%20the%20scenes%20just%20by%20looking%20at%20plaintext%2fciphertext%20pairs."><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2ffernetinjection.github.io%2fposts%2f2021-02-02-encryptor%2f&t=Encrypt0r"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu class=icon href=# onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden=true></i>Menu</a>
<a id=toc class=icon href=# onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden=true></i>TOC</a>
<a id=share class=icon href=# onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden=true></i>share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i>Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2021 fernetInjection</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>